matrix: 
  include:
    - os: osx
      osx_image: xcode9.4
      language: node_js
      node_js: 10
      env:
        - ELECTRON_CACHE=$HOME/.cache/electron
        - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
  
    - os: linux
      language: node_js
      node_js: 10

    - os: linux
      dist: xenial
      language: minimal
      services:
        - docker
      env:
        - CROSS=1
        - CROSS_ARCH=armv7l
        - CROSS_IMAGE=arm32v7/node:10-stretch

    - os: windows
      language: node_js
      node_js: 10
      filter_secrets: false

cache:
  directories:
    - $HOME/.npm
    - $HOME/.cache/electron
    - $HOME/.cache/electron-builder

before_install:
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      if [ "$CROSS" ]; then
        docker run --rm --privileged hypriot/qemu-register
        docker create \
          -it --name cross \
          -v $(pwd):/home/node/app \
          -v $HOME/.cache/electron:/home/node/.cache/electron \
          -v $HOME/.cache/electron-builder:/home/node/.cache/electron-builder \
          -w /home/node/app \
          "$CROSS_IMAGE"
        docker start cross
        docker exec -it cross /bin/sh -c "apt update -y"
        docker exec -it cross /bin/sh -c "
          apt install -y \
            git \
            automake \
            gconf2 \
            gconf-service \
            libnotify4 \
            libappindicator1 \
            libxtst6 \
            libnss3 \
            libxext-dev \
            libxkbfile-dev \
            libxtst-dev \
            libopenjp2-tools \
            snapd
        "
        docker exec -it cross /bin/sh -c "
          cd /usr/src
          git clone https://git.kernel.org/pub/scm/fs/squashfs/squashfs-tools.git
          cd squashfs-tools/squashfs-tools
          make install
        "
        docker exec -it -u node cross /bin/sh -c "
          mkdir -p  /home/node/.cache/electron-builder/appimage/appimage-9.1.0/linux-arm
          cd /home/node/.cache/electron-builder/appimage/appimage-9.1.0/linux-arm
          ln -s /usr/local/bin/mksquashfs mksquashfs
        "
        docker exec -it cross /bin/sh -c "snap install snapcraft --classic"
        docker exec -it cross \
          /bin/sh -c "chown -R node:node /home/node/app"
        docker exec -it -u node cross \
          /bin/sh -c "npm install"
      else
        sudo apt-get install \
          automake \
          libgconf-2-4 \
          libtool \
          libxext-dev \
          libxkbfile-dev \
          libxtst-dev
      fi
    else
      npm uninstall --save mouse-forward-back
    fi

script:
  - |
    if [ "$CROSS" ]; then
      docker exec -it \
        -u node \
        --env-file <(env | grep -iE 'DEBUG|NODE_|ELECTRON_|YARN_|NPM_|CI|CIRCLE|TRAVIS_TAG|TRAVIS|TRAVIS_REPO_|TRAVIS_BUILD_|TRAVIS_BRANCH|TRAVIS_PULL_REQUEST_|APPVEYOR_|CSC_|GH_|GITHUB_|BT_|AWS_|STRIP|BUILD_') \
        --env ELECTRON_CACHE="/home/node/.cache/electron" \
        --env ELECTRON_BUILDER_CACHE="/home/node/.cache/electron-builder" \
        cross \
        /bin/sh -c \
          "npm test && npm run dist -- --arch=${CROSS_ARCH}"
    else
      npm test && npm run dist
    fi

branches:
  except:
    - "/^v\\d+\\.\\d+\\.\\d+$/"
